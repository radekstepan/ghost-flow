<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Flow</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PyQt WebChannel (Local File) -->
    <script src="qwebchannel.js"></script>

    <style>
        /* Transparent base for Glassmorphism */
        html, body {
            background-color: transparent;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Fallback UI (no React) */
        .gf-fallback-wrap {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            color: #e5e7eb;
            background: rgba(10, 10, 10, 0.85);
        }
        .gf-fallback-card {
            max-width: 520px;
            margin: 24px;
            padding: 20px 22px;
            border-radius: 14px;
            background: rgba(15, 15, 15, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }
        .gf-fallback-card h1 {
            margin: 0 0 6px 0;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        .gf-fallback-card p {
            margin: 0;
            font-size: 12px;
            color: #9ca3af;
            line-height: 1.5;
        }
        .gf-overlay-wrap {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }
        /* Fallback pill style */
        .gf-overlay-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            background: rgba(15, 15, 15, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.05); /* reduced opacity */
            color: #e5e7eb;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            transition: all 180ms ease;
        }
        .gf-overlay-pill.gf-done {
            background: rgba(20, 20, 20, 0.95);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .gf-overlay-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #6366f1;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.6);
        }
        .gf-overlay-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #9ca3af;
        }
        .gf-overlay-text {
            font-size: 12px;
            color: #f9fafb;
        }
        .gf-hidden {
            display: none;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Animations */
        @keyframes waveform {
            0%, 100% { height: 4px; }
            50% { height: 14px; }
        }
        .animate-wave {
            animation: waveform 1s ease-in-out infinite;
        }

        /* Ambient Blobs Animation */
        @keyframes float-blob-1 {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(20px, -30px) scale(1.05); }
            66% { transform: translate(-10px, 10px) scale(0.95); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        @keyframes float-blob-2 {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(-20px, 30px) scale(1.05); }
            66% { transform: translate(10px, -10px) scale(0.95); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob-1 {
            animation: float-blob-1 25s infinite ease-in-out;
        }
        .animate-blob-2 {
            animation: float-blob-2 30s infinite ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full">
        <!-- Loader fallback -->
        <div class="flex h-full items-center justify-center text-gray-500 text-xs font-mono">
            Initializing Interface...
        </div>
    </div>

    <script type="text/javascript">
        (function () {
            const root = document.getElementById('root');
            if (!root) return;

            const mode = window.location.hash.replace('#', '') || 'settings';
            const fallbackState = { stage: 'idle', text: '' };
            let bridgeReady = false;

            function renderFallbackSettings() {
                root.innerHTML = `
                    <div class="gf-fallback-wrap">
                        <div class="gf-fallback-card">
                            <h1>UI Assets Not Loaded</h1>
                            <p>The app is running, but the UI bundle didnâ€™t load. This can happen if the network is offline or remote scripts are blocked.</p>
                            <p style="margin-top:8px;">Check your internet connection, then restart Ghost Flow.</p>
                        </div>
                    </div>
                `;
            }

            function renderFallbackOverlay() {
                root.innerHTML = `
                    <div class="gf-overlay-wrap">
                        <div id="gf-overlay-pill" class="gf-overlay-pill gf-hidden">
                            <div class="gf-overlay-dot"></div>
                            <div>
                                <div id="gf-overlay-title" class="gf-overlay-title">Idle</div>
                                <div id="gf-overlay-text" class="gf-overlay-text"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function updateOverlay(state) {
                const pill = document.getElementById('gf-overlay-pill');
                const title = document.getElementById('gf-overlay-title');
                const text = document.getElementById('gf-overlay-text');
                if (!pill || !title || !text) return;

                if (state.stage === 'idle' || state.stage === 'done') {
                    pill.classList.add('gf-hidden');
                    return;
                }

                pill.classList.remove('gf-hidden');
                title.textContent = 'Listening...';
                text.textContent = state.text || '';
            }

            function connectBridge() {
                if (bridgeReady) return;
                if (!window.qt || !window.qt.webChannelTransport || !window.QWebChannel) {
                    setTimeout(connectBridge, 200);
                    return;
                }

                new QWebChannel(window.qt.webChannelTransport, (channel) => {
                    const pyBridge = channel.objects.pyBridge;
                    if (!pyBridge || !pyBridge.overlay_update) return;
                    bridgeReady = true;

                    pyBridge.overlay_update.connect((jsonStr) => {
                        try {
                            const data = JSON.parse(jsonStr);
                            fallbackState.stage = data.stage;
                            fallbackState.text = data.text || '';
                            updateOverlay(fallbackState);
                        } catch (e) {
                            console.error('Fallback overlay parse error', e);
                        }
                    });

                    if (pyBridge.get_overlay_state) {
                        pyBridge.get_overlay_state((jsonStr) => {
                            try {
                                const data = JSON.parse(jsonStr);
                                fallbackState.stage = data.stage;
                                fallbackState.text = data.text || '';
                                updateOverlay(fallbackState);
                            } catch (e) {
                                console.error('Fallback overlay get_overlay_state parse error', e);
                            }
                        });

                        setInterval(() => {
                            pyBridge.get_overlay_state((jsonStr) => {
                                try {
                                    const data = JSON.parse(jsonStr);
                                    fallbackState.stage = data.stage;
                                    fallbackState.text = data.text || '';
                                    updateOverlay(fallbackState);
                                } catch (e) {
                                    console.error('Fallback overlay poll parse error', e);
                                }
                            });
                        }, 250);
                    }
                });
            }

            window.addEventListener('gf:booted', () => {
                // React loaded, no fallback needed
                const current = document.getElementById('gf-overlay-pill');
                if (current) root.innerHTML = '';
            });

            setTimeout(() => {
                if (window.__GF_BOOTED__) return;
                if (mode === 'overlay') {
                    renderFallbackOverlay();
                    connectBridge();
                    updateOverlay(fallbackState);
                } else {
                    renderFallbackSettings();
                }
            }, 800);
        })();
    </script>

    <script type="text/babel">
        window.__GF_BOOTED__ = true;
        window.dispatchEvent(new Event('gf:booted'));
        try {
            const { useState, useEffect, useRef, useCallback } = React;

            // --- CONSTANTS ---
            const AUDIO_MODELS = [
                { id: 'whisper-1', label: 'Whisper-1 (Standard)' },
                { id: 'gpt-4o-mini-transcribe-2025-12-15', label: 'GPT-4o Mini Transcribe (Realtime)' }
            ];

            const REFINEMENT_MODELS = [
                { id: 'gpt-5-nano-2025-08-07', label: 'GPT-5 Nano (2025)' },
                { id: 'gpt-4o-mini', label: 'GPT-4o Mini (Standard)' },
                { id: 'gpt-4o', label: 'GPT-4o (High Intelligence)' }
            ];

            const isWhisperModel = (modelId) => (modelId || '').toLowerCase().includes('whisper');

            const OVERLAY_POSITIONS = [
                { id: 'top-right', label: 'Top Right' },
                { id: 'top-left', label: 'Top Left' },
                { id: 'top-center', label: 'Top Center' },
                { id: 'bottom-right', label: 'Bottom Right' },
                { id: 'bottom-left', label: 'Bottom Left' },
                { id: 'bottom-center', label: 'Bottom Center' },
                { id: 'center', label: 'Center Screen' },
            ];

            // --- ICONS ---
            const Icons = {
                Mic: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                ),
                Settings: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                ),
                Keyboard: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="4" width="20" height="16" rx="2" ry="2"/><line x1="6" y1="8" x2="6" y2="8"/><line x1="10" y1="8" x2="10" y2="8"/><line x1="14" y1="8" x2="14" y2="8"/><line x1="18" y1="8" x2="18" y2="8"/><line x1="6" y1="12" x2="6" y2="12"/><line x1="10" y1="12" x2="10" y2="12"/><line x1="14" y1="12" x2="14" y2="12"/><line x1="18" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="6" y2="16"/><line x1="10" y1="16" x2="15" y2="16"/></svg>
                ),
                Cpu: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>
                ),
                Activity: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                ),
                Check: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>
                ),
                Play: ({size=18, className=""}) => (
                     <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
                ),
                Copy: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                ),
                Alert: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                ),
                Trash: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                ),
                Layout: ({size=18, className=""}) => (
                    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                )
            };

            // --- OVERLAY WIDGET ---
            // Subtle border: border-white/5 (very faint)
            function OverlayWidget({ stage, text }) {
                const isListening = stage === 'listening' || stage === 'processing';
                const displayText = (text && text.trim()) ? text : 'Listening...';

                if (stage === 'idle' || stage === 'done') return null;

                return (
                    <div className={`
                        flex items-center gap-3 px-4 py-2.5 
                        rounded-xl 
                        bg-[#121212] 
                        border border-white/5 
                        shadow-none
                        transition-all duration-300 ease-out transform scale-100 origin-center
                    `}>
                        {/* Icon Area */}
                        <div className="relative flex items-center justify-center w-6 h-6 shrink-0">
                            <div className="flex items-center gap-0.5 h-3">
                                <div className={`w-1 bg-indigo-500 rounded-full ${isListening ? 'animate-wave' : ''}`} style={{animationDelay: '0ms'}}></div>
                                <div className={`w-1 bg-purple-500 rounded-full ${isListening ? 'animate-wave' : ''}`} style={{animationDelay: '100ms'}}></div>
                                <div className={`w-1 bg-pink-500 rounded-full ${isListening ? 'animate-wave' : ''}`} style={{animationDelay: '200ms'}}></div>
                            </div>
                        </div>

                        {/* Content Area - Transitions width based on content */}
                        <div className="flex flex-col justify-center min-w-[100px] max-w-[240px]">
                            <span className="text-[10px] font-bold uppercase tracking-wider mb-0 text-gray-500">
                                Ghost Flow
                            </span>
                            
                            <div className="text-[12px] text-white/90 leading-tight">
                                {displayText}
                            </div>
                        </div>
                    </div>
                );
            }

            // --- DEBOUNCE HOOK ---
            function useDebounce(value, delay) {
                const [debouncedValue, setDebouncedValue] = useState(value);
                useEffect(() => {
                    const handler = setTimeout(() => {
                        setDebouncedValue(value);
                    }, delay);
                    return () => clearTimeout(handler);
                }, [value, delay]);
                return debouncedValue;
            }

            // --- HISTORY COMPONENT ---
            function HistoryView({ bridge }) {
                const [history, setHistory] = useState([]);
                const [loading, setLoading] = useState(true);

                const fetchHistory = useCallback(() => {
                    if (!bridge) return;
                    if (bridge.get_history) {
                        bridge.get_history((jsonStr) => {
                            try {
                                const data = JSON.parse(jsonStr);
                                setHistory(data);
                            } catch (e) { console.error("History parse error", e); }
                            setLoading(false);
                        });
                    }
                }, [bridge]);

                useEffect(() => {
                    fetchHistory();
                    const interval = setInterval(fetchHistory, 3000);
                    return () => clearInterval(interval);
                }, [fetchHistory]);

                const clearAll = () => {
                    if (confirm("Clear all history?")) {
                        bridge.clear_history();
                        setHistory([]);
                    }
                };

                const copyText = (text) => {
                    navigator.clipboard.writeText(text).catch(e => console.error("Copy failed", e));
                };

                if (loading) return <div className="text-gray-500 text-sm p-4">Loading history...</div>;

                return (
                    <div className="space-y-6 max-w-3xl animate-in fade-in duration-300">
                        <header className="flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl font-bold mb-1">History</h1>
                                <p className="text-gray-400 text-sm">Recent transcriptions (stored locally).</p>
                            </div>
                            {history.length > 0 && (
                                <button onClick={clearAll} className="px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 text-red-400 text-xs rounded-lg border border-red-500/20 flex items-center gap-2 transition-colors">
                                    <Icons.Trash size={14} /> Clear
                                </button>
                            )}
                        </header>

                        {history.length === 0 ? (
                            <div className="text-center py-12 border border-white/5 rounded-xl border-dashed">
                                <p className="text-gray-500 text-sm">No history yet.</p>
                                <p className="text-gray-600 text-xs mt-1">Record something to see it here.</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {history.map((item, idx) => (
                                    <div key={idx} className="group relative p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-colors">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="text-xs text-gray-500 font-mono">{item.date_str}</span>
                                            <button onClick={() => copyText(item.text)} className="opacity-0 group-hover:opacity-100 p-1.5 hover:bg-white/10 rounded-md text-gray-400 hover:text-white transition-all" title="Copy">
                                                <Icons.Copy size={14} />
                                            </button>
                                        </div>
                                        <p className="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap">{item.text}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            }

            // --- DASHBOARD ---
            function Dashboard({ bridge, overlayState }) {
                const [activeTab, setActiveTab] = useState('general');
                const [permissionsGranted, setPermissionsGranted] = useState(true);
                const [settingsLoaded, setSettingsLoaded] = useState(false);
                const skipNextSaveRef = useRef(true);
                
                const [settings, setSettings] = useState({
                    openai_api_key: '',
                    transcription_model: 'whisper-1',
                    model: 'gpt-4o-mini',
                    system_prompt: '',
                    sound_feedback: true,
                    overlay_position: 'top-right', // Default matching python
                    streaming_enabled: false,
                    vad_silence_ms: 600,
                    vad_aggressiveness: 2
                });

                // Debounce settings object for saving
                const debouncedSettings = useDebounce(settings, 800);

                // Initial Load
                useEffect(() => {
                    if (!bridge) return;
                    
                    if (bridge.get_settings) {
                        bridge.get_settings((jsonStr) => {
                            console.log("JS [Dashboard]: Settings loaded", jsonStr);
                            try {
                                const data = JSON.parse(jsonStr);
                                setSettings(prev => ({ ...prev, ...data }));
                                setSettingsLoaded(true);
                                skipNextSaveRef.current = true;
                                if (data.permissions_granted === false) setPermissionsGranted(false);
                                else setPermissionsGranted(true);
                            } catch(e) { console.error(e); }
                        });
                    }
                }, [bridge]);

                // Save Effect
                useEffect(() => {
                    if (!bridge || !settingsLoaded) return;
                    if (skipNextSaveRef.current) {
                        skipNextSaveRef.current = false;
                        return;
                    }
                    console.log("JS: Saving settings (debounced)");
                    bridge.save_settings(JSON.stringify(debouncedSettings));
                }, [debouncedSettings, bridge, settingsLoaded]);

                const updateSetting = (key, value) => {
                    setSettings(prev => ({ ...prev, [key]: value }));
                };

                // Helper to determine status UI for footer
                const getStatusUI = () => {
                    if (!permissionsGranted) {
                        return { 
                            dot: 'bg-red-500 animate-pulse', 
                            label: 'System: Paused', 
                            sub: 'Permissions Required', 
                            textClass: 'text-red-400' 
                        };
                    }
                    
                    const { stage, text } = overlayState || { stage: 'idle' };
                    
                    if (stage === 'listening') {
                        return { 
                            dot: 'bg-indigo-500 animate-pulse', 
                            label: 'Listening...', 
                            sub: 'Release F8 to finish', 
                            textClass: 'text-indigo-400' 
                        };
                    }
                    if (stage === 'processing') {
                        return { 
                            dot: 'bg-purple-500 animate-pulse', 
                            label: 'Processing...', 
                            sub: 'Ghost Flow is thinking', 
                            textClass: 'text-purple-400' 
                        };
                    }
                    if (stage === 'done') {
                        return { 
                            dot: 'bg-emerald-500', 
                            label: 'Complete', 
                            sub: text || 'Pasted to clipboard', 
                            textClass: 'text-emerald-400' 
                        };
                    }
                    
                    return { 
                        dot: 'bg-emerald-500/50', 
                        label: 'System: Online', 
                        sub: 'Ready to record (F8)', 
                        textClass: 'text-gray-500' 
                    };
                };

                const status = getStatusUI();

                return (
                    <div className="relative flex h-screen w-full bg-neutral-900 text-gray-100 font-sans selection:bg-indigo-500/30 overflow-hidden">
                        
                        {/* Background Ambience */}
                        <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none">
                            <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-indigo-600 rounded-full blur-[120px] opacity-10 animate-blob-1"></div>
                            <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-600 rounded-full blur-[120px] opacity-10 animate-blob-2"></div>
                        </div>

                        {/* Sidebar */}
                        <div className="relative z-10 w-64 bg-black/20 border-r border-white/5 flex flex-col justify-between backdrop-blur-sm">
                            <div>
                                <div className="flex items-center gap-3 px-6 py-6 mb-2">
                                    <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20">
                                        <Icons.Mic size={18} className="text-white" />
                                    </div>
                                    <span className="font-bold text-lg tracking-tight">Ghost Flow</span>
                                </div>

                                <nav className="space-y-1 px-2">
                                    <NavItem icon={<Icons.Settings size={18} />} label="General" active={activeTab === 'general'} onClick={() => setActiveTab('general')} />
                                    <NavItem icon={<Icons.Keyboard size={18} />} label="Shortcuts" active={activeTab === 'shortcuts'} onClick={() => setActiveTab('shortcuts')} />
                                    <NavItem icon={<Icons.Cpu size={18} />} label="Models" active={activeTab === 'models'} onClick={() => setActiveTab('models')} />
                                    <NavItem icon={<Icons.Activity size={18} />} label="History" active={activeTab === 'history'} onClick={() => setActiveTab('history')} />
                                </nav>
                            </div>

                            {/* Extended Footer Status */}
                            <div className="px-6 py-4 border-t border-white/5 bg-black/10 backdrop-blur-md">
                                <div className="flex items-start gap-3">
                                    <div className={`mt-1.5 w-2 h-2 rounded-full shrink-0 ${status.dot} shadow-sm`}></div>
                                    <div className="flex-1 overflow-hidden">
                                        <div className={`text-xs font-medium ${status.textClass}`}>{status.label}</div>
                                        <div className="text-[10px] text-gray-500 truncate mt-0.5 leading-tight opacity-70" title={status.sub}>
                                            {status.sub}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Content Area */}
                        <div className="relative z-10 flex-1 p-10 overflow-y-auto custom-scrollbar bg-neutral-800/50">
                            
                            {!permissionsGranted && (
                                <div className="mb-8 p-4 bg-red-500/10 border border-red-500/20 rounded-xl flex items-start gap-4 animate-in fade-in slide-in-from-top-4 duration-500">
                                    <div className="p-2 bg-red-500/20 rounded-lg text-red-400 mt-1">
                                        <Icons.Alert size={20} />
                                    </div>
                                    <div>
                                        <h3 className="text-red-400 font-bold text-sm uppercase tracking-wide mb-1">Accessibility Access Required</h3>
                                        <p className="text-gray-300 text-sm mb-3 leading-relaxed">
                                            Ghost Flow cannot listen for the activation key (F8) because macOS is blocking input monitoring.
                                        </p>
                                        <div className="text-xs text-gray-400 bg-black/20 p-3 rounded-lg border border-white/5 font-mono space-y-1.5">
                                            <p>1. Open <span className="text-white">System Settings</span> &gt; <span className="text-white">Privacy & Security</span> &gt; <span className="text-white">Accessibility</span></p>
                                            <p>2. Toggle ON for <span className="text-white">Terminal</span> or <span className="text-white">Python</span></p>
                                            <p>3. If already ON, toggle it OFF and ON again.</p>
                                            <p>4. <span className="text-white underline">Restart Ghost Flow</span> to apply changes.</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'general' && (
                                <div className="space-y-8 max-w-2xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <header>
                                        <h1 className="text-2xl font-bold mb-1">General Settings</h1>
                                        <p className="text-gray-400 text-sm">Configure how Ghost Flow listens and behaves.</p>
                                    </header>

                                    <section className="space-y-4">
                                        <div className="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-colors">
                                            <div className="space-y-1">
                                                <h3 className="font-medium">Sound Feedback</h3>
                                                <p className="text-xs text-gray-400">Play a subtle sound when recording starts/stops.</p>
                                            </div>
                                            <Toggle active={settings.sound_feedback} onClick={() => updateSetting('sound_feedback', !settings.sound_feedback)} />
                                        </div>

                                        <div className="p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-colors">
                                            <div className="flex items-center justify-between">
                                                <div className="space-y-1">
                                                    <h3 className="font-medium">Streaming Mode</h3>
                                                    <p className="text-xs text-gray-400">Show partial results while you speak (VAD-based).</p>
                                                </div>
                                                <Toggle active={settings.streaming_enabled} onClick={() => updateSetting('streaming_enabled', !settings.streaming_enabled)} />
                                            </div>

                                            <div className="mt-4 space-y-3">
                                                <div>
                                                    <div className="flex items-center justify-between text-xs text-gray-400 mb-1">
                                                        <span>Silence Threshold</span>
                                                        <span>{settings.vad_silence_ms} ms</span>
                                                    </div>
                                                    <input
                                                        type="range"
                                                        min="300"
                                                        max="1200"
                                                        step="50"
                                                        value={settings.vad_silence_ms}
                                                        onChange={(e) => updateSetting('vad_silence_ms', parseInt(e.target.value, 10))}
                                                        className="w-full accent-indigo-500"
                                                    />
                                                </div>

                                                <div>
                                                    <div className="flex items-center justify-between text-xs text-gray-400 mb-1">
                                                        <span>VAD Aggressiveness</span>
                                                        <span>{settings.vad_aggressiveness}</span>
                                                    </div>
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="3"
                                                        step="1"
                                                        value={settings.vad_aggressiveness}
                                                        onChange={(e) => updateSetting('vad_aggressiveness', parseInt(e.target.value, 10))}
                                                        className="w-full accent-indigo-500"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-colors">
                                            <div className="flex items-center gap-3 mb-3">
                                                <Icons.Layout size={18} className="text-gray-400" />
                                                <h3 className="font-medium">Overlay Position</h3>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                {OVERLAY_POSITIONS.map(pos => (
                                                    <button
                                                        key={pos.id}
                                                        onClick={() => updateSetting('overlay_position', pos.id)}
                                                        className={`text-left text-xs px-3 py-2 rounded-lg border transition-all ${settings.overlay_position === pos.id ? 'bg-indigo-600/20 border-indigo-500/50 text-indigo-200' : 'bg-black/20 border-transparent text-gray-400 hover:bg-white/5'}`}
                                                    >
                                                        {pos.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </section>
                                </div>
                            )}

                            {activeTab === 'models' && (
                                <div className="space-y-8 max-w-2xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <header>
                                        <h1 className="text-2xl font-bold mb-1">Models & API</h1>
                                        <p className="text-gray-400 text-sm">Connect your brains and ears.</p>
                                    </header>
                                    <section className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">OpenAI API Key</label>
                                            <div className="relative">
                                                <input 
                                                    type="password" 
                                                    value={settings.openai_api_key} 
                                                    onChange={(e) => updateSetting('openai_api_key', e.target.value)}
                                                    placeholder="sk-proj-..."
                                                    className="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500/50 text-gray-300 font-mono"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Audio Input Model (Transcription)</label>
                                            <select 
                                                value={settings.transcription_model}
                                                onChange={(e) => updateSetting('transcription_model', e.target.value)}
                                                className="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500/50 text-gray-300"
                                            >
                                                {AUDIO_MODELS.map(m => (
                                                    <option key={m.id} value={m.id}>{m.label}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {isWhisperModel(settings.transcription_model) ? (
                                            <>
                                                <div>
                                                    <label className="block text-sm font-medium mb-2">Refinement Model (Post-Processing)</label>
                                                    <select 
                                                        value={settings.model}
                                                        onChange={(e) => updateSetting('model', e.target.value)}
                                                        className="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500/50 text-gray-300"
                                                    >
                                                        {REFINEMENT_MODELS.map(m => (
                                                            <option key={m.id} value={m.id}>{m.label}</option>
                                                        ))}
                                                    </select>
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium mb-2">System Prompt</label>
                                                    <textarea 
                                                        value={settings.system_prompt}
                                                        onChange={(e) => updateSetting('system_prompt', e.target.value)}
                                                        className="w-full h-32 bg-neutral-900 border border-white/10 rounded-lg p-4 text-sm focus:outline-none focus:border-indigo-500/50 text-gray-300 font-mono resize-none leading-relaxed"
                                                    />
                                                </div>
                                            </>
                                        ) : (
                                            <div className="text-xs text-gray-500 bg-black/20 border border-white/5 rounded-lg p-3">
                                                Realtime transcription models return final text directly and skip post-processing.
                                            </div>
                                        )}
                                    </section>
                                </div>
                            )}
                            
                            {activeTab === 'shortcuts' && (
                                <div className="space-y-8 max-w-2xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <header>
                                        <h1 className="text-2xl font-bold mb-1">Keyboard Shortcuts</h1>
                                        <p className="text-gray-400 text-sm">Customize your global trigger key.</p>
                                    </header>
                                    <div className="p-6 bg-white/5 rounded-xl border border-white/5">
                                        <label className="block text-sm font-medium mb-4">Global Trigger</label>
                                        <div className="flex items-center gap-4">
                                            <div className="h-14 flex-1 bg-neutral-900 rounded-lg border border-white/10 flex items-center px-4 justify-between group">
                                                <span className="text-gray-400">Press combination...</span>
                                                <kbd className="px-2 py-1 bg-white/10 rounded text-xs font-mono text-gray-300 border border-white/10 shadow-sm min-w-[24px] text-center">F8</kbd>
                                            </div>
                                            <button className="h-14 px-6 rounded-lg bg-white/5 border border-white/10 text-sm font-medium text-gray-400 cursor-not-allowed">Reset</button>
                                        </div>
                                        <p className="mt-3 text-xs text-gray-500">Hold this key to start recording. Release to process and paste.</p>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'history' && (
                                <HistoryView bridge={bridge} />
                            )}
                        </div>
                    </div>
                );
            }

            function NavItem({ icon, label, active, onClick }) {
                return (
                    <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${active ? 'bg-white/10 text-white shadow-lg shadow-black/20' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                        <div className={`${active ? 'text-indigo-400' : 'text-gray-500'}`}>{icon}</div>{label}
                    </button>
                );
            }

            function Toggle({ active, onClick }) {
                return (
                    <div onClick={onClick} className={`w-11 h-6 rounded-full p-1 transition-colors cursor-pointer ${active ? 'bg-indigo-600' : 'bg-gray-700'}`}>
                        <div className={`w-4 h-4 rounded-full bg-white shadow-sm transform transition-transform ${active ? 'translate-x-5' : 'translate-x-0'}`}></div>
                    </div>
                );
            }

            // --- ROOT APP ---
            function App() {
                const [viewMode, setViewMode] = useState('settings');
                const [overlayState, setOverlayState] = useState({ stage: 'idle', text: '' });
                const [bridge, setBridge] = useState(null);
                const [bridgeError, setBridgeError] = useState(false);

                // Robust Bridge Connection with Retry
                useEffect(() => {
                    const mode = window.location.hash.replace('#', '');
                    console.log("JS: Init App, mode:", mode);
                    if (mode === 'overlay') setViewMode('overlay');

                    let attempts = 0;
                    let pollId = null;
                    const connectBridge = () => {
                        if (window.qt && window.qt.webChannelTransport) {
                            console.log("JS: Found qt.webChannelTransport, connecting...");
                            try {
                                new QWebChannel(window.qt.webChannelTransport, (channel) => {
                                    console.log("JS: QWebChannel fully connected.");
                                    const pyBridge = channel.objects.pyBridge;
                                    setBridge(pyBridge);
                                    setBridgeError(false);

                                    // Global listeners (useful for overlay)
                                    pyBridge.overlay_update.connect((jsonStr) => {
                                        console.log("JS [Global]: overlay_update", jsonStr);
                                        const data = JSON.parse(jsonStr);
                                        setOverlayState(data);
                                    });

                                    if (pyBridge.get_overlay_state) {
                                        pyBridge.get_overlay_state((jsonStr) => {
                                            try {
                                                const data = JSON.parse(jsonStr);
                                                setOverlayState(data);
                                            } catch (e) {
                                                console.error("JS: get_overlay_state parse error", e);
                                            }
                                        });

                                        pollId = setInterval(() => {
                                            pyBridge.get_overlay_state((jsonStr) => {
                                                try {
                                                    const data = JSON.parse(jsonStr);
                                                    setOverlayState(data);
                                                } catch (e) {
                                                    console.error("JS: get_overlay_state poll parse error", e);
                                                }
                                            });
                                        }, 250);
                                    }
                                });
                            } catch (e) {
                                console.error("JS: QWebChannel creation failed:", e);
                                setBridgeError(true);
                            }
                        } else {
                            attempts++;
                            if (attempts < 20) { // Retry for ~2 seconds
                                console.log(`JS: Waiting for qt transport... (${attempts})`);
                                setTimeout(connectBridge, 100);
                            } else {
                                console.error("JS: Timeout waiting for qt.webChannelTransport");
                                setBridgeError(true);
                            }
                        }
                    };

                    connectBridge();
                    return () => {
                        if (pollId) clearInterval(pollId);
                    };
                }, []);

                if (viewMode === 'overlay') {
                    if (bridgeError) {
                         return <div className="text-red-500 font-mono text-xs bg-black/80 p-2 rounded">Error: No Bridge</div>;
                    }
                    if (!bridge && overlayState.stage === 'idle') {
                        // Keep hidden or show debug
                        return null; 
                    }
                    // FIXED: Center the widget properly within the python window
                    return (
                        <div className="flex items-center justify-center w-full h-full">
                            <OverlayWidget stage={overlayState.stage} text={overlayState.text} />
                        </div>
                    );
                }

                // Pass overlayState to Dashboard for status footer
                return <Dashboard bridge={bridge} overlayState={overlayState} />;
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);

        } catch (error) {
            console.error("React Crash:", error);
            document.getElementById('root').innerHTML = "<div style='color:red; padding:20px'>Critical UI Error: " + error.message + "</div>";
        }
    </script>
</body>
</html>
